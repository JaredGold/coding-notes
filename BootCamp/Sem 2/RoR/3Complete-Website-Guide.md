# Web Dev - 4.0
- Add Stripe gem `gem 'stripe'`
- EDITOR="code --wait" rails credentials:edit
- Add below
```yml
stripe:
  secret_key:
  public_key:
```
- Create `config/initializers/stripe.rb/
- Add `Stripe.api_key = Rails.application.credentials.dig(:stripe, :secret_key)` to that file
- In `listings_controller.rb`
```ruby
def show
  session = Stripe::Checkout::Session.create(
    payment_method_types: ['card'],
    customer_email: current_user.email,
    line_items: [{
      name: @listing.title,
      description: @listing.description,
      amount: @listing.price * 100, # Stripe takes money by cents
      currency: 'aud',
      quantity: 1
    }],
    payment_intent_data: {
      metadata: {
        user_id: current_user.id,
        listing_id: @listing.id
      }
    },
    success_url: "#{root_url}payments/success?listingId=#{@listing.id}",
    # Todo check if we can use listings_path
    cancel_url: "#{root_url}listings"
  )

  @session_id = session.id
end
```

- Add the below to `show.html.erb`
```erb
<button data-stripe="payment">
Buy Now!
</button>

<script src="https://js.stripe.com/v3/"></script>
<script>
  document
    .querySelector("[data-stripe='payment']")
    .addEventListener("click", () => {
      const stripe = Stripe(
        "<%= Rails.application.credentials.dig(:stripe, :public_key) %>"
      )

      stripe.redirectToCheckout({
        sessionId: "<%= @session_id %>"
      })

    })
</script>
```

- create the success landing page/controller
- Install ultrahook to track if purchase was made succesfully
- On Stripe's website use `developers/webhooks` and add an endpoint
- The endpoint is the link generated by ultrahook and then the event to send is your choice but we used payments_successful
